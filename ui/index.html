<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Chatbot Messenger Block</title>
<style>
body { font-family: Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 0; }
#chatIcon { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: #0078FF; color: white; display: flex; align-items: center; justify-content: center; font-size: 30px; cursor: pointer; z-index: 1000;}
#chatPopup { position: fixed; bottom: 90px; right: 20px; width: 350px; height: 500px; background: #fff; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.3); display: none; flex-direction: column; overflow: hidden; z-index: 999; }
.chatbox { flex: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; }
.message { display: flex; margin-bottom: 10px; }
.message.bot { justify-content: flex-start; }
.message.user { justify-content: flex-end; }
.bubble { max-width: 75%; padding: 10px 15px; border-radius: 20px; word-wrap: break-word; }
.bot .bubble { background: #f1f0f0; border: 1px solid #ccc; }
.user .bubble { background: #0078FF; color: white; }
.chat-input { display: flex; border-top: 1px solid #ccc; padding: 5px; }
.chat-input input { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #ccc; }
.chat-input button { margin-left: 5px; padding: 10px 15px; border-radius: 50%; border: none; background-color: #0078FF; color: white; cursor: pointer; }
button:hover { background-color: #005FCC; }
.card { border: 1px solid #ccc; border-radius: 10px; padding: 8px; margin: 5px 0 0 0; background: #fff; }
.card strong { display: block; margin-bottom: 4px; }
.card button { margin-top: 5px; padding: 6px 10px; border-radius: 5px; border: none; background-color: #0078FF; color: white; cursor: pointer; }
.card button:hover { background-color: #005FCC; }
</style>
</head>
<body>

<div id="chatIcon">ü©∫</div>

<div id="chatPopup">
  <div class="chatbox" id="chatbox"></div>
  <div class="chat-input">
    <input type="text" id="userInput" placeholder="Nh·∫≠p tin nh·∫Øn...">
    <button id="sendBtn">‚û§</button>
  </div>
</div>

<script>
const chatIcon = document.getElementById("chatIcon");
const chatPopup = document.getElementById("chatPopup");
const chatbox = document.getElementById("chatbox");
const userInput = document.getElementById("userInput");
const sendBtn = document.getElementById("sendBtn");

chatIcon.addEventListener("click", ()=>{
  chatPopup.style.display = chatPopup.style.display==="flex" ? "none" : "flex";
});

function addMessage(content, sender="bot", isHTML=false){
  const msg = document.createElement("div");
  msg.className = `message ${sender}`;
  const bubble = document.createElement("div");
  bubble.className = "bubble";
  if(isHTML) bubble.innerHTML = content;
  else bubble.textContent = content;
  msg.appendChild(bubble);
  chatbox.appendChild(msg);
  chatbox.scrollTop = chatbox.scrollHeight;
  return bubble;
}

function addCard(item){
  const card = document.createElement("div");
  card.className = "card";
  const title = document.createElement("strong");
  title.textContent = item.title;
  const desc = document.createElement("span");
  desc.textContent = item.description;
  const btn = document.createElement("button");
  btn.textContent = "M·ªü t√†i li·ªáu";
  btn.onclick = ()=> alert(`G·ªçi h√†m ${item.tool} cho '${item.title}'`);
  card.appendChild(title);
  card.appendChild(desc);
  card.appendChild(btn);
  return card;
}

// Nh·∫≠n di·ªán JSON trong ph·∫£n h·ªìi
function extractJSON(text){
  const start = text.indexOf("{");
  const end = text.lastIndexOf("}");
  if(start!==-1 && end!==-1 && end>start){
    const jsonStr = text.slice(start,end+1);
    const normalText = text.slice(0,start).trim();
    try{
      const jsonObj = JSON.parse(jsonStr);
      return {normalText,jsonObj};
    }catch(e){
      return {normalText,text};
    }
  }
  return {normalText:text,jsonObj:null};
}

function processBotResponse(raw){
  const {normalText,jsonObj} = extractJSON(raw);
  // T·∫°o 1 bubble duy nh·∫•t
  const bubble = addMessage("","bot");

  // Th√™m text v√†o bubble
  normalText.split(/\n+/).forEach(line=>{
    if(line.startsWith("### ")) bubble.innerHTML += `<strong>${line.slice(4)}</strong><br>`;
    else if(line.trim()) bubble.innerHTML += line + "<br>";
  });

  // Th√™m JSON card v√†o c√πng bubble
  if(jsonObj){
    bubble.innerHTML += "<em>D∆∞·ªõi ƒë√¢y l√† t√†i li·ªáu tham kh·∫£o:</em><br>";
    Object.values(jsonObj).forEach(item=>{
      bubble.appendChild(addCard(item));
    });
  }
}

// Khi ng∆∞·ªùi d√πng g·ª≠i tin nh·∫Øn
sendBtn.addEventListener("click",()=>{
  const text = userInput.value.trim();
  if(!text) return;
  addMessage(text,"user");
  userInput.value = "";
  setTimeout(()=> processBotResponse(rawBotResponse), 500);
});

userInput.addEventListener("keypress",(e)=>{
  if(e.key==="Enter") sendBtn.click();
});

const rawBotResponse = `
### Chu·∫©n ƒëo√°n: ƒêau rƒÉng, s∆∞ng n∆∞·ªõu, h∆°i th·ªü c√≥ m√πi
### Tri·ªáu ch·ª©ng: Vi√™m quanh ch√≥p rƒÉng c·∫•p t√≠nh
{
  "documpent": {
    "title": "ƒêi·ªÅu tr·ªã vi√™m quanh ch√≥p rƒÉng",
    "tool": "call_document",
    "description": "T·ªïng quan v·ªÅ nguy√™n nh√¢n v√† ph√°c ƒë·ªì ƒëi·ªÅu tr·ªã vi√™m quanh ch√≥p"
  },
  "cme": {
    "title": "C·∫≠p nh·∫≠t ki·∫øn th·ª©c v·ªÅ vi√™m t·ªßy",
    "tool": "call_cme",
    "description": "Kh√≥a h·ªçc CME cung c·∫•p ki·∫øn th·ª©c m·ªõi nh·∫•t v·ªÅ ƒëi·ªÅu tr·ªã t·ªßy rƒÉng"
  }
}
`;
</script>

</body>
</html>
